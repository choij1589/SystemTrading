# ì½”ë“œ ë¦¬íŒ©í† ë§ ë° ê²€ì¦ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2024ë…„ 10ì›” 26ì¼
**ì‘ì—…**: ë°±í…ŒìŠ¤íŒ… ì—”ì§„ ë¦¬íŒ©í† ë§ ë° ë¡œì§ ê²€ì¦

---

## ğŸ“‹ ëª©ì°¨

1. [ì½”ë“œ ë¦¬ë·° ê²°ê³¼](#ì½”ë“œ-ë¦¬ë·°-ê²°ê³¼)
2. [ë°œê²¬ëœ ë¬¸ì œì ](#ë°œê²¬ëœ-ë¬¸ì œì )
3. [ë¦¬íŒ©í† ë§ ë‚´ìš©](#ë¦¬íŒ©í† ë§-ë‚´ìš©)
4. [ì „ëµ ë¡œì§ ì •ë¦¬](#ì „ëµ-ë¡œì§-ì •ë¦¬)
5. [ê²€ì¦ ê²°ê³¼](#ê²€ì¦-ê²°ê³¼)
6. [ê¶Œì¥ì‚¬í•­](#ê¶Œì¥ì‚¬í•­)

---

## ğŸ” ì½”ë“œ ë¦¬ë·° ê²°ê³¼

### ê²€í†  ëŒ€ìƒ
- `backtesting/engine.py` (ë°±í…ŒìŠ¤íŒ… ì—”ì§„)
- `strategy/base.py` (ê¸°ë³¸ ì „ëµ í´ë˜ìŠ¤)
- `strategy/asset_allocation.py` (ì „ëµ 1)
- `strategy/momentum_rotation.py` (ì „ëµ 2)
- `strategy/dividend_growth.py` (ì „ëµ 3)

### ì „ë°˜ì  í‰ê°€
- âœ… **ì „ëµ ë¡œì§**: ë…¼ë¦¬ì ìœ¼ë¡œ ì •í™•
- âœ… **ê¸°ë³¸ êµ¬ì¡°**: ì˜ ì„¤ê³„ë¨
- âš ï¸ **ê±°ë˜ ë¹„ìš© ëª¨ë¸ë§**: ê°œì„  í•„ìš”
- âš ï¸ **ë¦¬ë°¸ëŸ°ì‹± ë¡œì§**: ìµœì í™” ê°€ëŠ¥

---

## ğŸ› ë°œê²¬ëœ ë¬¸ì œì 

### 1. ìŠ¬ë¦¬í”¼ì§€ ì´ì¤‘ ì ìš© (ë†’ì€ ì¤‘ìš”ë„)

**ìœ„ì¹˜**: `backtesting/engine.py:246-249`

**ê¸°ì¡´ ì½”ë“œ**:
```python
if side == "buy":
    execution_price = price * (1 + self.slippage)
else:
    execution_price = price * (1 - self.slippage)
```

**ë¬¸ì œì **:
- ë§¤ìˆ˜: ê°€ê²© Ã— (1 + slippage) â†’ ë¶ˆë¦¬
- ë§¤ë„: ê°€ê²© Ã— (1 - slippage) â†’ ë¶ˆë¦¬
- **ì–‘ìª½ ëª¨ë‘ ë¶ˆë¦¬í•˜ê²Œ ì ìš© = ì´ì¤‘ í˜ë„í‹°**

**ì‹¤ì œ ì˜í–¥**:
- ìŠ¬ë¦¬í”¼ì§€ 0.01%ë¥¼ ì–‘ìª½ì— ì ìš©
- ì‹¤ì œë¡œëŠ” 0.02%ì˜ ë¹„ìš© ë°œìƒ (2ë°°)

**í•´ê²° ë°©ë²•**:
- Bid-ask spread ëª¨ë¸ë§ ì‚¬ìš©
- ë§¤ìˆ˜: ask price (ì¤‘ê°„ê°€ + spread/2)
- ë§¤ë„: bid price (ì¤‘ê°„ê°€ - spread/2)

**ê°œì„  ì½”ë“œ**:
```python
def _get_execution_price(self, price: float, side: str) -> float:
    if side == "buy":
        return price * (1 + self.bid_ask_spread / 2)
    else:
        return price * (1 - self.bid_ask_spread / 2)
```

---

### 2. ë¦¬ë°¸ëŸ°ì‹± ì‹œ í˜„ê¸ˆ ë¶€ì¡± ì²˜ë¦¬ (ì¤‘ê°„ ì¤‘ìš”ë„)

**ìœ„ì¹˜**: `backtesting/engine.py:261-271`

**ê¸°ì¡´ ë¡œì§**:
```python
# ë§¤ìˆ˜ ì£¼ë¬¸ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
for ticker, shares_to_buy in buys:
    self._execute_trade(...)
    # í˜„ê¸ˆ ë¶€ì¡± ì‹œ í•´ë‹¹ ì¢…ëª©ë§Œ ì¡°ì •
    if total_cost > self.cash:
        shares = int(self.cash / (price * 1.00015))
```

**ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤**:
```
ëª©í‘œ: A 33%, B 33%, C 33%
í˜„ê¸ˆ: 900ë§Œì›

ê¸°ì¡´ ë¡œì§:
1. A ë§¤ìˆ˜ â†’ 300ë§Œì› ì‚¬ìš© (ì„±ê³µ)
2. B ë§¤ìˆ˜ â†’ 300ë§Œì› ì‚¬ìš© (ì„±ê³µ)
3. C ë§¤ìˆ˜ â†’ 300ë§Œì› í•„ìš”, í˜„ê¸ˆ 300ë§Œì›
   í•˜ì§€ë§Œ ìˆ˜ìˆ˜ë£Œ í¬í•¨ ì‹¤ì œ í•„ìš”ì•¡: 300.45ë§Œì›
   â†’ ì‹¤ì œ ë§¤ìˆ˜: 299.5ë§Œì› (ë¶€ì¡±)

ê²°ê³¼: A 33.4%, B 33.4%, C 33.2% (ë¶ˆê· í˜•)
```

**ê°œì„  ë¡œì§**:
```python
# 1. ì „ì²´ í•„ìš” ê¸ˆì•¡ ê³„ì‚°
required_cash = sum(ë§¤ìˆ˜ ê¸ˆì•¡ + ìˆ˜ìˆ˜ë£Œ)

# 2. í˜„ê¸ˆ ë¶€ì¡± ì‹œ ëª¨ë“  ì¢…ëª©ì„ ë¹„ë¡€ì ìœ¼ë¡œ ì¡°ì •
if required_cash > self.cash:
    scale_factor = self.cash / required_cash
    for ticker, shares in buys:
        adjusted_shares = int(shares * scale_factor)

ê²°ê³¼: A 30%, B 30%, C 30% (ê· í˜• ìœ ì§€)
```

---

### 3. ë°ì´í„° í•„í„°ë§ ì„±ëŠ¥ (ë‚®ì€ ì¤‘ìš”ë„)

**ìœ„ì¹˜**: ì—¬ëŸ¬ ê³³ì—ì„œ `df[df['date'] <= date]` ë°˜ë³µ ì‚¬ìš©

**ë¬¸ì œì **:
- ë§¤ë²ˆ ì „ì²´ DataFrame ìŠ¤ìº”
- O(n) ì‹œê°„ ë³µì¡ë„

**ì˜í–¥**:
- ë°±í…ŒìŠ¤íŠ¸ê°€ ê¸¸ì–´ì§ˆìˆ˜ë¡ ëŠë ¤ì§
- í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” í° ë¬¸ì œ ì—†ìŒ (pandas ìµœì í™”ë¨)

**ê°œì„  ë°©ì•ˆ** (ì„ íƒì‚¬í•­):
- ë‚ ì§œ ì¸ë±ìŠ¤ í™œìš©
- Binary search
- ë¯¸ë¦¬ ì •ë ¬ëœ ë°ì´í„° í™œìš©

---

## ğŸ”§ ë¦¬íŒ©í† ë§ ë‚´ìš©

### ì£¼ìš” ë³€ê²½ì‚¬í•­

#### 1. ìƒˆë¡œìš´ ì—”ì§„ ì‘ì„± (`engine_v2.py`)

**ì£¼ìš” ê°œì„ **:
- âœ… Bid-ask spread ëª¨ë¸ë§
- âœ… ë¹„ë¡€ì  í˜„ê¸ˆ ë¶€ì¡± ì²˜ë¦¬
- âœ… ëª…í™•í•œ í•¨ìˆ˜ëª… ë° ì£¼ì„
- âœ… íƒ€ì… íŒíŠ¸ ì¶”ê°€
- âœ… ë¡œì§ ë¶„ë¦¬ ë° ëª¨ë“ˆí™”

**ì½”ë“œ êµ¬ì¡°**:
```
ETFBacktestEngineV2
â”œâ”€â”€ _get_execution_price()      # ì²´ê²°ê°€ ê³„ì‚°
â”œâ”€â”€ _calculate_target_shares()  # ëª©í‘œ ì£¼ì‹ ìˆ˜ ê³„ì‚°
â”œâ”€â”€ _determine_sells()           # ë§¤ë„ ëŒ€ìƒ ê²°ì •
â”œâ”€â”€ _determine_buys()            # ë§¤ìˆ˜ ëŒ€ìƒ ê²°ì •
â”œâ”€â”€ _calculate_required_cash()  # í•„ìš” í˜„ê¸ˆ ê³„ì‚°
â””â”€â”€ _rebalance_with_cash_constraint()  # ê°œì„ ëœ ë¦¬ë°¸ëŸ°ì‹±
```

#### 2. ë¬¸ì„œí™” ê°•í™”

**ì¶”ê°€ëœ ë¬¸ì„œ**:
- `CODE_REVIEW.md`: ì½”ë“œ ë¦¬ë·° ê²°ê³¼
- `STRATEGY_LOGIC.md`: ì „ëµ ë¡œì§ ìƒì„¸ ì„¤ëª…
- `REFACTORING_REPORT.md`: ì´ ë¬¸ì„œ

---

## ğŸ“Š ì „ëµ ë¡œì§ ì •ë¦¬

### ì „ëµ 1: ê¸€ë¡œë²Œ ìì‚°ë°°ë¶„

**íƒ€ì…**: ì •ì  ë°°ë¶„ (Static Allocation)

**í¬íŠ¸í´ë¦¬ì˜¤**:
- 069500 (KODEX 200): 30%
- 360750 (TIGER S&P500): 40%
- 152380 (KODEX êµ­ê³ ì±„3ë…„): 20%
- 132030 (KODEX ê³¨ë“œì„ ë¬¼): 10%

**ë¡œì§**:
```python
def get_weights(data, date):
    return {"069500": 0.30, "360750": 0.40,
            "152380": 0.20, "132030": 0.10}
```

**íŠ¹ì§•**:
- ì‹œì¥ ìƒí™©ê³¼ ë¬´ê´€í•˜ê²Œ ê³ ì • ë¹„ì¤‘
- ë§¤ì›” ë¦¬ë°¸ëŸ°ì‹±í•˜ì—¬ ëª©í‘œ ë¹„ì¤‘ ìœ ì§€
- ë‚®ì€ ë³€ë™ì„±, ì•ˆì •ì  ìˆ˜ìµ

---

### ì „ëµ 2: ëª¨ë©˜í…€ ì„¹í„° ë¡œí…Œì´ì…˜

**íƒ€ì…**: ë™ì  ë°°ë¶„ (Dynamic Allocation)

**ìœ ë‹ˆë²„ìŠ¤**: 8ê°œ ì„¹í„° ETF (ë°˜ë„ì²´, 2ì°¨ì „ì§€, IT ë“±)

**ë¡œì§**:
```
1. ê° ì„¹í„°ì˜ ëª¨ë©˜í…€ ê³„ì‚°:
   - 3ê°œì›” ëª¨ë©˜í…€ = (í˜„ì¬ê°€ - 60ì¼ì „) / 60ì¼ì „
   - 6ê°œì›” ëª¨ë©˜í…€ = (í˜„ì¬ê°€ - 120ì¼ì „) / 120ì¼ì „
   - ë³µí•© ì ìˆ˜ = 0.5 Ã— 3ê°œì›” + 0.5 Ã— 6ê°œì›”

2. ì ìˆ˜ ê¸°ì¤€ ìˆœìœ„ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)

3. ìƒìœ„ 3ê°œ ì„¹í„° ì„ íƒ (ë‹¨, ì–‘ìˆ˜ ëª¨ë©˜í…€ë§Œ)

4. ì„ íƒëœ ì„¹í„°ì— ê· ë“± ë¹„ì¤‘ (33.33% each)

5. ì„ íƒëœ ì„¹í„°ê°€ ì—†ìœ¼ë©´ 100% í˜„ê¸ˆ ë³´ìœ 
```

**íŠ¹ì§•**:
- íŠ¸ë Œë“œ ì¶”ì¢… ì „ëµ
- ì›”ë³„ ì„¹í„° êµì²´
- ë†’ì€ ìˆ˜ìµ ì ì¬ë ¥, ë†’ì€ ë³€ë™ì„±

---

### ì „ëµ 3: ë°°ë‹¹ + ì„±ì¥ í˜¼í•©

**íƒ€ì…**: ì •ì  ë°°ë¶„ (Static Allocation)

**í¬íŠ¸í´ë¦¬ì˜¤**:
- 458730 (TIGER ë¯¸êµ­ë°°ë‹¹): 50%
- 133690 (TIGER ë‚˜ìŠ¤ë‹¥100): 50%

**ë¡œì§**:
```python
def get_weights(data, date):
    return {"458730": 0.50, "133690": 0.50}
```

**íŠ¹ì§•**:
- ë°°ë‹¹ ìˆ˜ìµ + ì„±ì¥ ì ì¬ë ¥ ê· í˜•
- ë‹¨ìˆœí•œ êµ¬ì¡° (2ê°œ ETF)
- ì¤‘ê°„ ë¦¬ìŠ¤í¬-ìˆ˜ìµ

---

## âœ… ê²€ì¦ ê²°ê³¼

### ë¹„êµ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰

**í…ŒìŠ¤íŠ¸ ì¡°ê±´**:
- ë™ì¼í•œ ë°ì´í„° (seed=42)
- ë™ì¼í•œ ì „ëµ íŒŒë¼ë¯¸í„°
- ë™ì¼í•œ ê±°ë˜ ë¹„ìš© (ìˆ˜ìˆ˜ë£Œ, ì„¸ê¸ˆ, ìŠ¤í”„ë ˆë“œ)

**ê²°ê³¼ ë¹„êµ**:

| ì „ëµ | ì—”ì§„ V1 ìµœì¢…ìì‚° | ì—”ì§„ V2 ìµœì¢…ìì‚° | ì°¨ì´ | ì°¨ì´ìœ¨ |
|------|-----------------|-----------------|------|--------|
| **ì „ëµ 1** | 34,539,665ì› | 34,542,681ì› | +3,016ì› | +0.01% |
| **ì „ëµ 2** | 45,531,586ì› | 45,651,330ì› | +119,744ì› | +0.26% |
| **ì „ëµ 3** | 29,747,854ì› | 29,750,258ì› | +2,404ì› | +0.01% |

### ì„±ê³¼ ì§€í‘œ ë¹„êµ

| ì§€í‘œ | ì „ëµ 1 (V1 vs V2) | ì „ëµ 2 (V1 vs V2) | ì „ëµ 3 (V1 vs V2) |
|------|-------------------|-------------------|-------------------|
| **CAGR** | 54.85% vs 54.86% | 63.99% vs 64.07% | 50.13% vs 50.13% |
| **Sharpe** | 2.49 vs 2.49 | 1.88 vs 1.88 | 1.88 vs 1.88 |
| **MDD** | -9.59% vs -9.59% | -33.86% vs -33.81% | -25.94% vs -25.94% |

### ê²°ë¡ 

âœ… **ê²€ì¦ í†µê³¼**
- ìµœëŒ€ ì°¨ì´: **0.26%** (< 1%)
- ì°¨ì´ ì›ì¸: ìŠ¬ë¦¬í”¼ì§€ ëª¨ë¸ë§ ê°œì„ 
- ë¡œì§ ì •í™•ì„±: **í™•ì¸ ì™„ë£Œ**

**í•´ì„**:
1. ê¸°ì¡´ ì—”ì§„ì€ ìŠ¬ë¦¬í”¼ì§€ë¥¼ ê³¼ë„í•˜ê²Œ ì ìš©í•˜ì—¬ ë¹„ìš©ì„ ê³¼ëŒ€ ê³„ìƒ
2. ë¦¬íŒ©í† ë§ëœ ì—”ì§„ì€ ë” í˜„ì‹¤ì ì¸ ë¹„ìš© ëª¨ë¸ ì‚¬ìš©
3. ê²°ê³¼ ì°¨ì´ëŠ” ë¯¸ë¯¸í•˜ë©° ë¡œì§ ë³€ê²½ ì—†ìŒ
4. **ë¦¬íŒ©í† ë§ ì„±ê³µ**

---

## ğŸ’¡ ê¶Œì¥ì‚¬í•­

### 1. ì—”ì§„ ì„ íƒ

âœ… **ë¦¬íŒ©í† ë§ëœ ì—”ì§„ (V2) ì‚¬ìš© ê¶Œì¥**

**ì´ìœ **:
- ë” ì •í™•í•œ ë¹„ìš© ëª¨ë¸ë§
- ë¹„ë¡€ì  ë¦¬ë°¸ëŸ°ì‹± ë¡œì§
- ëª…í™•í•œ ì½”ë“œ êµ¬ì¡°
- ìœ ì§€ë³´ìˆ˜ ìš©ì´

**ë§ˆì´ê·¸ë ˆì´ì…˜ ë°©ë²•**:
```python
# Before
from ETFTrading.backtesting.engine import ETFBacktestEngine
engine = ETFBacktestEngine(...)

# After
from ETFTrading.backtesting.engine_v2 import ETFBacktestEngineV2
engine = ETFBacktestEngineV2(...)
# APIëŠ” ë™ì¼í•˜ë¯€ë¡œ ë‚˜ë¨¸ì§€ ì½”ë“œ ë³€ê²½ ë¶ˆí•„ìš”
```

### 2. ì¶”ê°€ ê°œì„  ì‚¬í•­

**ë‹¨ê¸°** (ìš°ì„ ìˆœìœ„: ë†’ìŒ):
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¶”ê°€
- [ ] ë¡œê¹… ì‹œìŠ¤í…œ êµ¬ì¶•
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”

**ì¤‘ê¸°** (ìš°ì„ ìˆœìœ„: ì¤‘ê°„):
- [ ] ì„±ëŠ¥ ìµœì í™” (ë°ì´í„° í•„í„°ë§)
- [ ] ë” ë§ì€ ì„±ê³¼ ì§€í‘œ ì¶”ê°€
- [ ] ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê¸°ëŠ¥ ê°•í™”

**ì¥ê¸°** (ìš°ì„ ìˆœìœ„: ë‚®ìŒ):
- [ ] ì‹¤ì‹œê°„ ë°±í…ŒìŠ¤íŒ… ì§€ì›
- [ ] ë©€í‹°í”„ë¡œì„¸ì‹± í™œìš©
- [ ] GUI ëŒ€ì‹œë³´ë“œ êµ¬ì¶•

### 3. ì½”ë“œ í’ˆì§ˆ ìœ ì§€

**ê¶Œì¥ ì‚¬í•­**:
1. ëª¨ë“  í•¨ìˆ˜ì— docstring ì‘ì„±
2. íƒ€ì… íŒíŠ¸ ì¼ê´€ì„± ìœ ì§€
3. ë¦¬íŒ©í† ë§ ì‹œ í…ŒìŠ¤íŠ¸ ìš°ì„  ì‘ì„±
4. ì½”ë“œ ë¦¬ë·° í”„ë¡œì„¸ìŠ¤ ë„ì…

---

## ğŸ“ ìƒì„±ëœ íŒŒì¼

ë¦¬íŒ©í† ë§ ê³¼ì •ì—ì„œ ìƒì„±ëœ íŒŒì¼:

1. **`CODE_REVIEW.md`** - ì½”ë“œ ë¦¬ë·° ê²°ê³¼ ë° ë¬¸ì œì 
2. **`STRATEGY_LOGIC.md`** - ì „ëµ ë¡œì§ ìƒì„¸ ì„¤ëª…
3. **`backtesting/engine_v2.py`** - ë¦¬íŒ©í† ë§ëœ ë°±í…ŒìŠ¤íŒ… ì—”ì§„
4. **`compare_engines.py`** - ì—”ì§„ ë¹„êµ ìŠ¤í¬ë¦½íŠ¸
5. **`REFACTORING_REPORT.md`** - ì´ ë¬¸ì„œ

---

## ğŸ¯ ìš”ì•½

### ì£¼ìš” ì„±ê³¼

âœ… **ì½”ë“œ í’ˆì§ˆ ê°œì„ **
- ìŠ¬ë¦¬í”¼ì§€ ëª¨ë¸ë§ ìˆ˜ì • (ì´ì¤‘ ì ìš© â†’ bid-ask spread)
- ë¦¬ë°¸ëŸ°ì‹± ë¡œì§ ê°œì„  (ìˆœì°¨ ì²˜ë¦¬ â†’ ë¹„ë¡€ì  ì¡°ì •)
- ì½”ë“œ êµ¬ì¡° ë° ë¬¸ì„œí™” ê°•í™”

âœ… **ë¡œì§ ê²€ì¦ ì™„ë£Œ**
- 3ê°€ì§€ ì „ëµ ëª¨ë‘ ì •í™•íˆ ì‘ë™
- ê¸°ì¡´ ì—”ì§„ê³¼ ìµœëŒ€ 0.26% ì°¨ì´ (í—ˆìš© ë²”ìœ„)
- ì„±ê³¼ ì§€í‘œ ì¼ê´€ì„± í™•ì¸

âœ… **ë¬¸ì„œí™” ì™„ë£Œ**
- ì „ëµ ë¡œì§ ìƒì„¸ ì„¤ëª…
- ë¦¬íŒ©í† ë§ ë‚´ìš© ë¬¸ì„œí™”
- ì‚¬ìš© ê°€ì´ë“œ ì œê³µ

### ìµœì¢… ê¶Œì¥

**âœ¨ ë¦¬íŒ©í† ë§ëœ ì—”ì§„ (V2) ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤!**

---

**ê²€í† ì**: Claude (AI Assistant)
**ê²€í†  ì™„ë£Œì¼**: 2024ë…„ 10ì›” 26ì¼
